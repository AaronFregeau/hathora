package rtag;

import java.util.List;
import java.util.Optional;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.FutureTask;

import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.fasterxml.jackson.annotation.JsonValue;

import lombok.Builder;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.NonNull;
import lombok.Setter;
import lombok.Value;
import lombok.extern.jackson.Jacksonized;

public class Types {
    {{#each types}}
    {{#if (eq type "enum")}}
    public enum {{@key}} {
        {{#each options}}
        {{label}}{{#unless @last}},{{else}};{{/unless}}
        {{/each}}

        @JsonValue
        public int toValue() {
            return ordinal();
        }
    }
    {{else if (eq type "object")}}
    @Value
    @Builder
    @Jacksonized
    {{!-- @NoArgsConstructor(force = true, access = AccessLevel.PRIVATE)
    @AllArgsConstructor --}}
    public static class {{@key}} {
        {{#each properties}}
        @JsonProperty("{{@key}}")
        private {{> renderArg}} {{@key}};
        {{/each}}
    }
    {{else}}
    @EqualsAndHashCode
    public static final class {{@key}} {
        private final {{> renderArg}} value;

        private {{@key}}(@NonNull {{> renderArg}} value) {
            this.value = value;
        }

        @JsonValue
        public {{> renderArg}} get() {
            return value;
        }

        @Override
        public String toString() {
            return value.toString();
        }

        @JsonCreator(mode = JsonCreator.Mode.DELEGATING)
        public static {{@key}} of(@NonNull {{> renderArg}} value) {
            return new {{@key}}(value);
        }
    }
    {{/if}}
    {{/each}}
    {{#each methods}}
    @Value
    @Builder
    @Jacksonized
    public static class {{makeRequestName @key}} {
        {{#each properties}}
        private {{> renderArg}} {{@key}};
        {{/each}}
    }
    {{/each}}
    {{!-- {{#each auth}}
    export interface {{capitalize @key}}UserData {
    type: "{{@key}}";
    id: string;
    {{#if (eq @key "anonymous")}}
    name: string;
    {{else if (eq @key "google")}}
    name: string;
    email: string;
    locale: string;
    picture: string;
    {{/if}}
    }
    {{/each}} --}}
    {{!-- export type UserData = {{#each auth}}{{capitalize @key}}UserData{{#unless @last}} | {{/unless}}{{/each}}; --}}
    {{!-- export interface SuccessResult {
    type: "success";
    }
    export interface ErrorResult {
    type: "error";
    error: {{error}};
    }
    export type Result = SuccessResult | ErrorResult;
    export const Result: { success: () => SuccessResult; error: (error: {{error}}) => ErrorResult } = {
    success: () => ({
        type: "success",
    }),
    error: (error: {{error}}) => ({
        type: "error",
        error,
    }),
    }; --}}

    @Value
    @Builder
    @Jacksonized
    public static class Result {
        public enum ResultType {
            @JsonProperty("success")
            SUCCESS,
            @JsonProperty("error")
            ERROR;
        }
        private ResultType type;
        private {{> renderError}} error;
    }

    @FunctionalInterface
    public interface StateChangeRunnable {
        public void run(Types.PlayerState state);
    }

    @Value
    @Builder
    public static class ResultCallback {
        private FutureTask<Result> future;
        private ResultCallable cb;

        @Getter
        @Setter
        public static class ResultCallable implements Callable<Result> {
            private Result result;

            public Result call() {
                return this.result;
            }
        }

        public Result get() throws InterruptedException, ExecutionException {
            return this.future.get();
        }
    }

    @Getter
    @Setter
    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class Message {
        private String type;
    }

    @Getter
    @Setter
    @Jacksonized
    public static class ResponseMessage extends Message {
        private String type;
        private String msgId;
        private Result result;
    }

    @Getter
    @Setter
    public static class StateMessage extends Message {
        private String type;
        private {{userState}} state;
    }

    @Getter
    @Setter
    public static class LoginResponse {
        private String token;
    }

    @Getter
    @Setter
    public static class CreateStateResponse {
        private String stateId;
    }
}
{{#*inline "renderArg"}}
{{#if alias}}
{{typeString}}
{{~else if (eq type "optional")}}
Optional<{{> renderArg item}}>
{{~else if (eq type "array")}}
List<{{> renderArg items}}>
{{~else if (eq type "number")}}
Integer
{{~else if (eq type "string")}}
String
{{~else if (eq type "boolean")}}
Boolean
{{~else if (eq type "plugin")}}
{{> renderArg item}}
{{~/if}}
{{~/inline}}

{{#*inline "renderError"}}
{{#if (eq error "number")}}
Integer
{{~else if (eq error "string")}}
String
{{~else if (eq error "boolean")}}
Boolean
{{~/if}}
{{~/inline}}